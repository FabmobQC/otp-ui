{"version":3,"sources":["../src/index.tsx"],"names":["Popup","Layer","Source","useMap","React","useCallback","useEffect","useMemo","useState","StopPopup","isGeoJsonFlex","StopsOverlay","props","map","current","activeStop","color","highlightedStop","highlightedStopColor","minZoom","refreshStops","setLocation","setViewedStop","stops","visible","clickedStop","setClickedStop","onLayerEnter","getCanvas","style","cursor","onLayerLeave","onLayerClick","event","features","properties","onZoomEnd","viewState","zoom","STOP_LAYERS","forEach","stopLayer","on","off","setNullStop","flexStops","filter","stop","geometries","geoJson","stopsGeoJSON","type","flex","highlighted","id","geometry","coordinates","lon","lat","length","location"],"mappings":";;;;;;;AAAA,SAASA,KAAT,QAAsB,2BAAtB;AAOA,SAASC,KAAT,EAAgBC,MAAhB,EAAwBC,MAAxB,QAAsC,cAAtC;AACA,OAAOC,KAAP,IAAgBC,WAAhB,EAA6BC,SAA7B,EAAwCC,OAAxC,EAAiDC,QAAjD,QAAiE,OAAjE;AAEA,OAAOC,SAAP,MAAsB,4BAAtB;AACA,SAASC,aAAT,QAA8B,SAA9B;;AA8CA;AACA;AACA;AACA,IAAMC,YAAY,GAAG,SAAfA,YAAe,CAACC,KAAD,EAA+B;AAClD,gBAAyBT,MAAM,EAA/B;AAAA,MAAiBU,GAAjB,WAAQC,OAAR;;AACA,MACEC,UADF,GAWIH,KAXJ,CACEG,UADF;AAAA,MAEEC,KAFF,GAWIJ,KAXJ,CAEEI,KAFF;AAAA,MAGEC,eAHF,GAWIL,KAXJ,CAGEK,eAHF;AAAA,MAIEC,oBAJF,GAWIN,KAXJ,CAIEM,oBAJF;AAAA,MAKEC,OALF,GAWIP,KAXJ,CAKEO,OALF;AAAA,MAMEC,YANF,GAWIR,KAXJ,CAMEQ,YANF;AAAA,MAOEC,YAPF,GAWIT,KAXJ,CAOES,WAPF;AAAA,MAQEC,cARF,GAWIV,KAXJ,CAQEU,aARF;AAAA,MASEC,KATF,GAWIX,KAXJ,CASEW,KATF;AAAA,MAUEC,OAVF,GAWIZ,KAXJ,CAUEY,OAVF;;AAYA,kBAAsChB,QAAQ,CAAC,IAAD,CAA9C;AAAA;AAAA,MAAOiB,WAAP;AAAA,MAAoBC,cAApB;;AAEA,MAAMC,YAAY,GAAGtB,WAAW,CAAC,YAAM;AACrCQ,IAAAA,GAAG,CAACe,SAAJ,GAAgBC,KAAhB,CAAsBC,MAAtB,GAA+B,SAA/B;AACD,GAF+B,EAE7B,CAACjB,GAAD,CAF6B,CAAhC;AAIA,MAAMkB,YAAY,GAAG1B,WAAW,CAAC,YAAM;AACrCQ,IAAAA,GAAG,CAACe,SAAJ,GAAgBC,KAAhB,CAAsBC,MAAtB,GAA+B,EAA/B;AACD,GAF+B,EAE7B,CAACjB,GAAD,CAF6B,CAAhC;AAIA,MAAMmB,YAAY,GAAG3B,WAAW,CAC9B,UAAC4B,KAAD,EAAsB;AAAA;;AACpBP,IAAAA,cAAc,oBAACO,KAAK,CAACC,QAAP,oDAAC,gBAAiB,CAAjB,EAAoBC,UAArB,CAAd;AACD,GAH6B,EAI9B,CAACT,cAAD,CAJ8B,CAAhC;AAOA,MAAMU,SAAS,GAAG/B,WAAW,CAC3B,UAAC4B,KAAD,EAAsB;AACpB,QAAIA,KAAK,CAACI,SAAN,CAAgBC,IAAhB,GAAuBnB,OAA3B,EAAoCO,cAAc,CAAC,IAAD,CAAd;AACrC,GAH0B,EAI3B,CAACA,cAAD,EAAiBP,OAAjB,CAJ2B,CAA7B;AAOAb,EAAAA,SAAS,CAAC,YAAM;AACdoB,IAAAA,cAAc,CAACX,UAAD,CAAd;AACD,GAFQ,EAEN,CAACA,UAAD,CAFM,CAAT;AAIAT,EAAAA,SAAS,CAAC,YAAM;AACd,QAAMiC,WAAW,GAAG,CAAC,OAAD,EAAU,YAAV,CAApB;AAEAA,IAAAA,WAAW,CAACC,OAAZ,CAAoB,UAAAC,SAAS,EAAI;AAC/B5B,MAAAA,GAAG,SAAH,IAAAA,GAAG,WAAH,YAAAA,GAAG,CAAE6B,EAAL,CAAQ,YAAR,EAAsBD,SAAtB,EAAiCd,YAAjC;AACAd,MAAAA,GAAG,SAAH,IAAAA,GAAG,WAAH,YAAAA,GAAG,CAAE6B,EAAL,CAAQ,YAAR,EAAsBD,SAAtB,EAAiCV,YAAjC;AACAlB,MAAAA,GAAG,SAAH,IAAAA,GAAG,WAAH,YAAAA,GAAG,CAAE6B,EAAL,CAAQ,OAAR,EAAiBD,SAAjB,EAA4BT,YAA5B;AACD,KAJD;AAMA,QAAIR,OAAO,IAAIJ,YAAf,EAA6BA,YAAY;AAEzCP,IAAAA,GAAG,SAAH,IAAAA,GAAG,WAAH,YAAAA,GAAG,CAAE6B,EAAL,CAAQ,SAAR,EAAmBN,SAAnB,EAXc,CAad;AACA;;AACA,WAAO,YAAM;AACXG,MAAAA,WAAW,CAACC,OAAZ,CAAoB,UAAAC,SAAS,EAAI;AAC/B5B,QAAAA,GAAG,SAAH,IAAAA,GAAG,WAAH,YAAAA,GAAG,CAAE8B,GAAL,CAAS,YAAT,EAAuBF,SAAvB,EAAkCd,YAAlC;AACAd,QAAAA,GAAG,SAAH,IAAAA,GAAG,WAAH,YAAAA,GAAG,CAAE8B,GAAL,CAAS,YAAT,EAAuBF,SAAvB,EAAkCV,YAAlC;AACAlB,QAAAA,GAAG,SAAH,IAAAA,GAAG,WAAH,YAAAA,GAAG,CAAE8B,GAAL,CAAS,OAAT,EAAkBF,SAAlB,EAA6BT,YAA7B;AACD,OAJD;AAKAnB,MAAAA,GAAG,SAAH,IAAAA,GAAG,WAAH,YAAAA,GAAG,CAAE8B,GAAL,CAAS,SAAT,EAAoBP,SAApB;AACD,KAPD;AAQD,GAvBQ,EAuBN,CAACvB,GAAD,EAAMW,OAAN,CAvBM,CAAT;AAyBA,MAAMoB,WAAW,GAAGvC,WAAW,CAAC,YAAM;AACpCqB,IAAAA,cAAc,CAAC,IAAD,CAAd;AACD,GAF8B,EAE5B,CAACD,WAAD,CAF4B,CAA/B;AAIA,MAAMoB,SAAS,GAAGtC,OAAO,CACvB;AAAA,WAAMgB,KAAK,CAACuB,MAAN,CAAa,UAAAC,IAAI;AAAA;;AAAA,aAAIrC,aAAa,CAACqC,IAAD,aAACA,IAAD,2CAACA,IAAI,CAAEC,UAAP,qDAAC,iBAAkBC,OAAnB,CAAjB;AAAA,KAAjB,CAAN;AAAA,GADuB,EAEvB,CAAC1B,KAAD,CAFuB,CAAzB;AAKA,MAAM2B,YAAuC,GAAG3C,OAAO,CACrD;AAAA,WAAO;AACL4C,MAAAA,IAAI,EAAE,mBADD;AAELjB,MAAAA,QAAQ,EAAEX,KAAK,CAACV,GAAN,CAAU,UAAAkC,IAAI;AAAA;;AAAA,eAAK;AAC3BI,UAAAA,IAAI,EAAE,SADqB;AAE3BhB,UAAAA,UAAU,kCACLY,IADK;AAERK,YAAAA,IAAI,EAAE1C,aAAa,CAACqC,IAAD,aAACA,IAAD,4CAACA,IAAI,CAAEC,UAAP,sDAAC,kBAAkBC,OAAnB,CAFX;AAGRI,YAAAA,WAAW,EAAEN,IAAI,CAACO,EAAL,KAAYrC;AAHjB,YAFiB;AAO3BsC,UAAAA,QAAQ,EAAE;AAAEJ,YAAAA,IAAI,EAAE,OAAR;AAAiBK,YAAAA,WAAW,EAAE,CAACT,IAAI,CAACU,GAAN,EAAWV,IAAI,CAACW,GAAhB;AAA9B;AAPiB,SAAL;AAAA,OAAd;AAFL,KAAP;AAAA,GADqD,EAarD,CAACnC,KAAD,EAAQN,eAAR,CAbqD,CAAvD,CA5EkD,CA4FlD;AACA;;AACA,MAAIO,OAAO,KAAK,KAAZ,IAAqB,CAACD,KAAtB,IAA+BA,KAAK,CAACoC,MAAN,KAAiB,CAApD,EAAuD;AACrD;AACA,wBAAO,yCAAP;AACD;;AAED,sBACE,uDACE,oBAAC,MAAD;AAAQ,IAAA,IAAI,EAAC,SAAb;AAAuB,IAAA,IAAI,EAAET;AAA7B,kBACE,oBAAC,KAAD;AACE,IAAA,EAAE,EAAC,OADL;AAEE,IAAA,OAAO,EAAE/B,OAAO,IAAI,EAFtB;AAGE,IAAA,KAAK,EAAE;AACL,sBAAgBH,KAAK,IAAI,MADpB;AAEL,wBAAkB,GAFb;AAGL;AACA,6BAAuBA,KAAK,GAAG,MAAH,GAAY,MAJnC;AAKL,6BAAuB;AALlB,KAHT;AAUE,IAAA,IAAI,EAAC;AAVP,IADF,eAaE,oBAAC,KAAD;AACE,IAAA,MAAM,EAAE,CAAC,IAAD,EAAO,aAAP,EAAsB,IAAtB,CADV;AAEE,IAAA,EAAE,EAAC,gBAFL;AAGE,IAAA,KAAK,EAAE;AACL,sBAAgBE,oBAAoB,IAAI,SADnC;AAEL,wBAAkB,CAFb;AAGL,uBAAiB,EAHZ;AAIL;AACA,6BAAuBF,KAAK,GAAG,MAAH,GAAY,MALnC;AAML,6BAAuB;AANlB,KAHT;AAWE,IAAA,IAAI,EAAC;AAXP,IAbF,eA0BE,oBAAC,KAAD;AACE,IAAA,MAAM,EAAE,CAAC,IAAD,EAAO,MAAP,EAAe,IAAf,CADV;AAEE,IAAA,EAAE,EAAC,YAFL;AAGE,IAAA,KAAK,EAAE;AACL,sBAAgB,CAAC,KAAD,EAAQ,OAAR,CADX;AAEL,wBAAkB,GAFb;AAGL,6BAAuB,MAHlB;AAIL,6BAAuB;AAJlB,KAHT;AASE,IAAA,IAAI,EAAC;AATP,IA1BF,CADF,EAuCGS,WAAW,iBACV,oBAAC,KAAD;AACE,IAAA,QAAQ,EAAEA,WAAW,CAACiC,GADxB;AAEE,IAAA,SAAS,EAAEjC,WAAW,CAACgC,GAFzB;AAGE,IAAA,QAAQ,EAAC,MAHX;AAIE,IAAA,OAAO,EAAEb;AAJX,kBAME,oBAAC,SAAD;AACE,IAAA,WAAW,EAAE,qBAAAgB,QAAQ,EAAI;AACvBhB,MAAAA,WAAW;;AACXvB,MAAAA,YAAW,CAACuC,QAAD,CAAX;AACD,KAJH;AAKE,IAAA,aAAa,EAAE,uBAAAb,IAAI,EAAI;AACrBH,MAAAA,WAAW;;AACXtB,MAAAA,cAAa,CAACyB,IAAD,CAAb;AACD,KARH;AASE,IAAA,MAAM,EAAEtB;AATV,IANF,CAxCJ,EA2DGoB,SAAS,CAAChC,GAAV,CAAc,UAAAkC,IAAI;AAAA,wBACjB,oBAAC,MAAD;AACE,MAAA,IAAI,EAAGA,IAAI,CAACC,UAAL,CAAgBC,OADzB;AAEE,MAAA,EAAE,EAAEF,IAAI,CAACO,EAFX;AAGE,MAAA,GAAG,EAAEP,IAAI,CAACO,EAHZ;AAIE,MAAA,IAAI,EAAC;AAJP,oBAOE,oBAAC,KAAD;AACE,MAAA,EAAE,EAAEP,IAAI,CAACO,EADX;AAEE,MAAA,KAAK,EAAE;AACL,sBAAcP,IAAI,CAAC/B,KADd;AAEL,wBAAgB,GAFX;AAGL,8BAAsB+B,IAAI,CAAC/B;AAHtB,OAFT;AAOE,MAAA,IAAI,EAAC;AAPP,MAPF,eAgBE,oBAAC,KAAD;AACE,MAAA,EAAE,YAAK+B,IAAI,CAACO,EAAV,aADJ;AAEE,MAAA,MAAM,EAAE;AAAE,qBAAa,OAAf;AAAwB,oBAAY;AAApC,OAFV;AAGE,MAAA,KAAK,EAAE;AACL,sBAAcP,IAAI,CAAC/B,KADd;AAEL,wBAAgB,CAFX;AAGL,sBAAc;AAHT,OAHT;AAQE,MAAA,IAAI,EAAC;AARP,MAhBF,CADiB;AAAA,GAAlB,CA3DH,CADF;AA2FD,CA9LD;;AAgMA,eAAeL,YAAf","sourcesContent":["import { Popup } from \"@opentripplanner/base-map\";\nimport {\n  MapLocationActionArg,\n  Stop,\n  StopEventHandler\n} from \"@opentripplanner/types\";\nimport { EventData } from \"mapbox-gl\";\nimport { Layer, Source, useMap } from \"react-map-gl\";\nimport React, { useCallback, useEffect, useMemo, useState } from \"react\";\n\nimport StopPopup from \"@opentripplanner/map-popup\";\nimport { isGeoJsonFlex } from \"./utils\";\n\ntype Props = {\n  /**\n   * Custom stop color passed from user config\n   */\n  color?: string;\n  /**\n   * An optional id to override the active stop with\n   */\n  activeStop?: string;\n  /**\n   * An optional id to highlight a stop on the map\n   */\n  highlightedStop?: string;\n  /**\n   * A color to use for the highlighted stop\n   */\n  highlightedStopColor?: string;\n  /**\n   * The list of stops to create stop markers for.\n   */\n  stops?: Stop[];\n\n  /**\n   * Whether or not to display the overlay\n   */\n  visible?: boolean;\n  /**\n   * The lowest zoom level the stop markers should be visible at\n   */\n  minZoom?: number;\n  /**\n   * A method to be fired when the map is moved\n   */\n  refreshStops?: () => void;\n  /**\n   * A method fired when a stop is selected as from or to in the popup\n   */\n  setLocation?: (location: MapLocationActionArg) => void;\n  /**\n   * A method fired when the stop viewer is opened in the popup\n   */\n  setViewedStop?: StopEventHandler;\n};\n\n/**\n * An overlay to view a collection of stops.\n */\nconst StopsOverlay = (props: Props): JSX.Element => {\n  const { current: map } = useMap();\n  const {\n    activeStop,\n    color,\n    highlightedStop,\n    highlightedStopColor,\n    minZoom,\n    refreshStops,\n    setLocation,\n    setViewedStop,\n    stops,\n    visible\n  } = props;\n  const [clickedStop, setClickedStop] = useState(null);\n\n  const onLayerEnter = useCallback(() => {\n    map.getCanvas().style.cursor = \"pointer\";\n  }, [map]);\n\n  const onLayerLeave = useCallback(() => {\n    map.getCanvas().style.cursor = \"\";\n  }, [map]);\n\n  const onLayerClick = useCallback(\n    (event: EventData) => {\n      setClickedStop(event.features?.[0].properties);\n    },\n    [setClickedStop]\n  );\n\n  const onZoomEnd = useCallback(\n    (event: EventData) => {\n      if (event.viewState.zoom < minZoom) setClickedStop(null);\n    },\n    [setClickedStop, minZoom]\n  );\n\n  useEffect(() => {\n    setClickedStop(activeStop);\n  }, [activeStop]);\n\n  useEffect(() => {\n    const STOP_LAYERS = [\"stops\", \"flex-stops\"];\n\n    STOP_LAYERS.forEach(stopLayer => {\n      map?.on(\"mouseenter\", stopLayer, onLayerEnter);\n      map?.on(\"mouseleave\", stopLayer, onLayerLeave);\n      map?.on(\"click\", stopLayer, onLayerClick);\n    });\n\n    if (visible && refreshStops) refreshStops();\n\n    map?.on(\"zoomend\", onZoomEnd);\n\n    // Remove event handlers when component unmounts\n    // (prevents error messages about performing state updates on unmounted component)\n    return () => {\n      STOP_LAYERS.forEach(stopLayer => {\n        map?.off(\"mouseenter\", stopLayer, onLayerEnter);\n        map?.off(\"mouseleave\", stopLayer, onLayerLeave);\n        map?.off(\"click\", stopLayer, onLayerClick);\n      });\n      map?.off(\"zoomend\", onZoomEnd);\n    };\n  }, [map, visible]);\n\n  const setNullStop = useCallback(() => {\n    setClickedStop(null);\n  }, [clickedStop]);\n\n  const flexStops = useMemo(\n    () => stops.filter(stop => isGeoJsonFlex(stop?.geometries?.geoJson)),\n    [stops]\n  );\n\n  const stopsGeoJSON: GeoJSON.FeatureCollection = useMemo(\n    () => ({\n      type: \"FeatureCollection\",\n      features: stops.map(stop => ({\n        type: \"Feature\",\n        properties: {\n          ...stop,\n          flex: isGeoJsonFlex(stop?.geometries?.geoJson),\n          highlighted: stop.id === highlightedStop\n        },\n        geometry: { type: \"Point\", coordinates: [stop.lon, stop.lat] }\n      }))\n    }),\n    [stops, highlightedStop]\n  );\n\n  // Don't render if no map or no stops are defined.\n  // (ZoomBasedMarkers will also not render below the minimum zoom threshold defined in the symbols prop.)\n  if (visible === false || !stops || stops.length === 0) {\n    // Null can't be returned here -- react-map-gl dislikes null values as children\n    return <></>;\n  }\n\n  return (\n    <>\n      <Source type=\"geojson\" data={stopsGeoJSON}>\n        <Layer\n          id=\"stops\"\n          minzoom={minZoom || 10}\n          paint={{\n            \"circle-color\": color || \"#fff\",\n            \"circle-opacity\": 0.9,\n            // TODO: Use tinycolor to generate outline with appropriate contrast.\n            \"circle-stroke-color\": color ? \"#fff\" : \"#333\",\n            \"circle-stroke-width\": 2\n          }}\n          type=\"circle\"\n        />\n        <Layer\n          filter={[\"==\", \"highlighted\", true]}\n          id=\"higlightedStop\"\n          paint={{\n            \"circle-color\": highlightedStopColor || \"#ff0000\",\n            \"circle-opacity\": 1,\n            \"circle-radius\": 10,\n            // TODO: Use tinycolor to generate outline with appropriate contrast.\n            \"circle-stroke-color\": color ? \"#fff\" : \"#333\",\n            \"circle-stroke-width\": 2\n          }}\n          type=\"circle\"\n        />\n        <Layer\n          filter={[\"==\", \"flex\", true]}\n          id=\"flex-stops\"\n          paint={{\n            \"circle-color\": [\"get\", \"color\"],\n            \"circle-opacity\": 0.9,\n            \"circle-stroke-color\": \"#333\",\n            \"circle-stroke-width\": 2\n          }}\n          type=\"circle\"\n        />\n      </Source>\n      {clickedStop && (\n        <Popup\n          latitude={clickedStop.lat}\n          longitude={clickedStop.lon}\n          maxWidth=\"100%\"\n          onClose={setNullStop}\n        >\n          <StopPopup\n            setLocation={location => {\n              setNullStop();\n              setLocation(location);\n            }}\n            setViewedStop={stop => {\n              setNullStop();\n              setViewedStop(stop);\n            }}\n            entity={clickedStop}\n          />\n        </Popup>\n      )}\n      {flexStops.map(stop => (\n        <Source\n          data={(stop.geometries.geoJson as unknown) as GeoJSON.Feature}\n          id={stop.id}\n          key={stop.id}\n          type=\"geojson\"\n        >\n          {/* TODO:  add support for overriding layer styles */}\n          <Layer\n            id={stop.id}\n            paint={{\n              \"fill-color\": stop.color,\n              \"fill-opacity\": 0.5,\n              \"fill-outline-color\": stop.color\n            }}\n            type=\"fill\"\n          />\n          <Layer\n            id={`${stop.id}-outline`}\n            layout={{ \"line-join\": \"round\", \"line-cap\": \"round\" }}\n            paint={{\n              \"line-color\": stop.color,\n              \"line-opacity\": 1,\n              \"line-width\": 4\n            }}\n            type=\"line\"\n          />\n        </Source>\n      ))}\n    </>\n  );\n};\n\nexport default StopsOverlay;\n\nexport { Props as StopProps };\n"],"file":"index.js"}