{"version":3,"sources":["../src/index.tsx"],"names":["coreUtils","getGeocoder","LocationIcon","React","useCallback","useEffect","useRef","useState","FormattedList","FormattedMessage","useIntl","Ban","Bus","ExclamationCircle","LocationArrow","Search","Times","debounce","GeocodedOptionIcon","ICON_SIZE","Option","TransitStopOption","UserLocationIcon","getRenderData","S","addInParentheses","generateLabel","getCombinedLabel","getGeocoderErrorMessage","getMatchingLocations","optionIdPrefix","getOptionId","index","optionKey","DefaultLocationIcon","locationType","filter","list","layers","include","limit","feature","includes","properties","layer","slice","getFeaturesByCategoryWithLimit","geocodedFeatures","suggestionCount","sortByDistance","preferredLayers","reduce","prev","cur","push","special","normal","sortedGeocodedFeatures","sort","a","b","distance","Infinity","stopFeatures","stationFeatures","otherFeatures","makeUserOption","userLocation","key","activeIndex","selectHandlers","displayName","icon","locationSelected","LocationField","addLocationSearch","autoFocus","className","clearButtonIcon","clearLocation","currentPosition","currentPositionIcon","currentPositionUnavailableIcon","findNearbyStops","GeocodedOptionIconComponent","geocoderConfig","getCurrentPosition","hideExistingValue","initialSearchResults","inputPlaceholder","isRequired","isStatic","isValid","layerColorMap","location","LocationIconComponent","nearbyStops","onLocationSelected","onTextInputClick","operatorIconMap","sessionOptionIcon","sessionSearches","showClearButton","showUserSettings","stopOptionIcon","stopsIndex","headingType","suggestionHeadingType","suppressNearby","UserLocationIconComponent","userLocationsAndRecentPlaces","getValueFromLocation","label","name","formControlClassname","listBoxId","intl","setActiveIndex","stateGeocodedFeatures","setGeocodedFeatures","menuVisible","setMenuVisible","isFetching","setFetching","stateMessage","setMessage","stateValue","setValue","abortControllers","setAbortController","inputRef","geocodeAutocomplete","text","console","warn","formatMessage","defaultMessage","description","id","newController","AbortController","autocomplete","options","signal","then","result","message","features","errorMessage","results","error","parts","length","count","hasResults","formatList","type","resultsFoundText","input","instructions","err","toString","closeMenu","setLocation","newLocation","resultType","useCurrentLocation","map","currentPositionToLocation","onClearButtonClick","current","focus","handleTextInputClick","onDropdownToggle","onBlurFormGroup","e","target","relatedTarget","document","activeElement","getAttribute","onTextInputChange","evt","value","forEach","ac","abort","coords","lat","latitude","lon","longitude","max","maxNearbyStops","onKeyDown","preventDefault","menuItemCount","locationSelectedLookup","geocodeSearch","search","renderFeature","itemIndex","main","secondary","getLocationFromGeocodedFeature","geocodedLocation","source","classNames","operatorIcon","featureIdComponents","split","operatorName","replace","toLowerCase","join","statusMessages","menuItems","userLocationRenderData","loc","matchingLocations","concat","transitFeaturesPresent","stations","stops","stopId","stop","stopLocation","option","sessionLocation","optionIcon","optionTitle","positionUnavailable","locationUnavailableText","errorText","undefined","unshift","defaultPlaceholder","placeholder","fetching","hasNoEnabledOptions","isExpanded","textControl","clearButton","ItemList","StaticMenuItemList","MenuItemList","Styled"],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/ban-ts-comment */\n/* eslint-disable @typescript-eslint/no-use-before-define */\nimport coreUtils from \"@opentripplanner/core-utils\";\nimport getGeocoder from \"@opentripplanner/geocoder\";\n// @ts-ignore Not Typescripted Yet\nimport LocationIcon from \"@opentripplanner/location-icon\";\nimport { Location } from \"@opentripplanner/types\";\nimport React, { useCallback, useEffect, useRef, useState } from \"react\";\nimport { FormattedList, FormattedMessage, useIntl } from \"react-intl\";\nimport { Ban } from \"@styled-icons/fa-solid/Ban\";\nimport { Bus } from \"@styled-icons/fa-solid/Bus\";\nimport { ExclamationCircle } from \"@styled-icons/fa-solid/ExclamationCircle\";\nimport { LocationArrow } from \"@styled-icons/fa-solid/LocationArrow\";\nimport { Search } from \"@styled-icons/fa-solid/Search\";\nimport { Times } from \"@styled-icons/fa-solid/Times\";\nimport { debounce } from \"throttle-debounce\";\n\nimport {\n  GeocodedOptionIcon,\n  ICON_SIZE,\n  Option,\n  TransitStopOption,\n  UserLocationIcon,\n  getRenderData\n} from \"./options\";\nimport * as S from \"./styled\";\nimport { LocationFieldProps, ResultType } from \"./types\";\nimport {\n  addInParentheses,\n  generateLabel,\n  getCombinedLabel,\n  getGeocoderErrorMessage,\n  getMatchingLocations\n} from \"./utils\";\n\nconst optionIdPrefix = \"otpui-locf-option\";\n\n/**\n * Formats the option id based on its given index position.\n * This assumes only one location dropdown is shown at a time.\n */\nfunction getOptionId(index: number): string {\n  return `${optionIdPrefix}-${index}`;\n}\n\n// FIXME have a better key generator for options\nlet optionKey = 0;\n\nfunction DefaultLocationIcon({\n  locationType\n}: {\n  locationType: string;\n}): React.ReactElement {\n  return <LocationIcon size={ICON_SIZE} type={locationType} />;\n}\n\n/**\n * Helper function that includes or excludes features based om layers.\n */\nfunction filter(\n  list: any[],\n  layers: string[],\n  include: boolean,\n  limit: number\n): any[] {\n  return list\n    .filter(feature => layers.includes(feature.properties.layer) === include)\n    .slice(0, limit);\n}\n\n/**\n * Puts the given geocoded features into several categories with upper bounds.\n */\nfunction getFeaturesByCategoryWithLimit(\n  geocodedFeatures: any[],\n  suggestionCount: number,\n  sortByDistance: boolean,\n  preferredLayers: string[]\n) {\n  // Split features into those we want to always show above others\n  const { special, normal } = geocodedFeatures.reduce(\n    (prev, cur) => {\n      prev[\n        preferredLayers.includes(cur?.properties?.layer) ? \"special\" : \"normal\"\n      ].push(cur);\n      return prev;\n    },\n    { special: [], normal: [] }\n  );\n\n  const sortedGeocodedFeatures = [\n    ...special,\n    ...normal.sort((a, b) => {\n      if (!sortByDistance) return 0;\n      return (\n        (b.properties?.distance || Infinity) -\n        (a.properties?.distance || Infinity)\n      );\n    })\n  ];\n\n  // Split out different types of transit results\n  // To keep the list tidy, only include a subset of the responses for each category\n  const stopFeatures = filter(\n    sortedGeocodedFeatures,\n    [\"stops\"],\n    true,\n    suggestionCount\n  );\n  const stationFeatures = filter(\n    sortedGeocodedFeatures,\n    [\"stations\"],\n    true,\n    suggestionCount\n  );\n  const otherFeatures = filter(\n    sortedGeocodedFeatures,\n    [\"stops\", \"stations\"],\n    false,\n    suggestionCount\n  );\n\n  return {\n    otherFeatures,\n    stationFeatures,\n    stopFeatures\n  };\n}\n\n/**\n * Helper to render and register a user-saved location.\n */\nfunction makeUserOption(userLocation, index, key, activeIndex, selectHandlers) {\n  const { displayName, icon, locationSelected } = userLocation;\n  // Add to the selection handler lookup (for use in onKeyDown)\n  selectHandlers[index] = locationSelected;\n  return (\n    <Option\n      icon={icon}\n      id={getOptionId(index)}\n      isActive={index === activeIndex}\n      key={key}\n      onClick={locationSelected}\n      title={displayName}\n    />\n  );\n}\n\nconst LocationField = ({\n  addLocationSearch = () => {},\n  autoFocus = false,\n  className = null,\n  clearButtonIcon = <Times size={ICON_SIZE} />,\n  clearLocation = () => {},\n  currentPosition = null,\n  currentPositionIcon = <LocationArrow size={ICON_SIZE} />,\n  currentPositionUnavailableIcon = <Ban size={ICON_SIZE} />,\n  findNearbyStops = () => {},\n  GeocodedOptionIconComponent = GeocodedOptionIcon,\n  geocoderConfig,\n  getCurrentPosition,\n  hideExistingValue = false,\n  initialSearchResults = null,\n  inputPlaceholder = null,\n  isRequired = false,\n  isStatic = false,\n  isValid = true,\n  layerColorMap = {},\n  location = null,\n  LocationIconComponent = DefaultLocationIcon,\n  locationType,\n  nearbyStops = [],\n  onLocationSelected,\n  onTextInputClick = null,\n  operatorIconMap = {},\n  preferredLayers = [],\n  sessionOptionIcon = <Search size={ICON_SIZE} />,\n  sessionSearches = [],\n  showClearButton = true,\n  showUserSettings = false,\n  sortByDistance = false,\n  stopOptionIcon = <Bus size={ICON_SIZE} />,\n  stopsIndex = null,\n  suggestionCount = 3,\n  suggestionHeadingType: headingType,\n  suppressNearby = false,\n  UserLocationIconComponent = UserLocationIcon,\n  userLocationsAndRecentPlaces = []\n}: LocationFieldProps): React.ReactElement => {\n  /**\n   * Gets the initial value to place in the input field.\n   */\n  const getValueFromLocation = () => {\n    const label = location?.name || \"\";\n    return location && !hideExistingValue ? label : \"\";\n  };\n\n  const formControlClassname = `${locationType}-form-control`;\n\n  const listBoxId = `${locationType}-listbox`;\n\n  const intl = useIntl();\n\n  const [activeIndex, setActiveIndex] = useState(null);\n  const [stateGeocodedFeatures, setGeocodedFeatures] = useState([]);\n  const [menuVisible, setMenuVisible] = useState(false);\n  const [isFetching, setFetching] = useState(false);\n  const [stateMessage, setMessage] = useState(null);\n  const [stateValue, setValue] = useState(getValueFromLocation());\n  const [abortControllers, setAbortController] = useState([]);\n\n  const inputRef = useRef(null);\n\n  useEffect(() => {\n    // location could be null if none is set\n    setValue(location?.name || \"\");\n    setGeocodedFeatures([]);\n  }, [location]);\n\n  useEffect(() => {\n    if (initialSearchResults) {\n      setGeocodedFeatures(initialSearchResults);\n      setMenuVisible(true);\n    }\n  }, [initialSearchResults]);\n\n  // TODO: is it possible to restore the useCallback while also setting\n  // a new abort controller?\n  const geocodeAutocomplete = debounce(300, (text: string) => {\n    if (!text) {\n      console.warn(\"No text entry provided for geocode autocomplete search.\");\n      setMessage(null);\n      return;\n    }\n    setFetching(true);\n    setMessage(\n      intl.formatMessage({\n        defaultMessage: \"Fetching suggestions…\",\n        description: \"Hint shown while geocoder suggestions are being fetched\",\n        id: \"otpUi.LocationField.fetchingSuggestions\"\n      })\n    );\n    const newController = new AbortController();\n    setAbortController([...abortControllers, newController]);\n\n    getGeocoder(geocoderConfig)\n      .autocomplete({ text, options: { signal: newController.signal } })\n      // TODO: Better type?\n      .then(\n        (result: {\n          features: Location[];\n          results: { error: { message: string } };\n        }) => {\n          let message: string;\n          // If no features found in response, default to empty array.\n          let geocodedFeatures = result?.features;\n          if (!geocodedFeatures) {\n            // Get the Pelias error message if exists.\n            // TODO: determine how other geocoders return error messages.\n            const errorMessage = result?.results?.error?.message;\n            // If the result did not contain a list of features, add special note.\n            message = getGeocoderErrorMessage(intl, errorMessage);\n            geocodedFeatures = [];\n          } else {\n            const {\n              otherFeatures,\n              stationFeatures,\n              stopFeatures\n            } = getFeaturesByCategoryWithLimit(\n              geocodedFeatures,\n              suggestionCount,\n              sortByDistance,\n              preferredLayers\n            );\n            // Breakdown results found by type.\n            const parts = [];\n            if (stopFeatures.length) {\n              parts.push(\n                intl.formatMessage(\n                  {\n                    description: \"Shows the count of transit stops\",\n                    id: \"otpUi.LocationField.stopCount\"\n                  },\n                  { count: stopFeatures.length }\n                )\n              );\n            }\n            if (stationFeatures.length) {\n              parts.push(\n                intl.formatMessage(\n                  {\n                    description: \"Shows the count of stations\",\n                    id: \"otpUi.LocationField.stationCount\"\n                  },\n                  { count: stationFeatures.length }\n                )\n              );\n            }\n            if (otherFeatures.length) {\n              parts.push(\n                intl.formatMessage(\n                  {\n                    description: \"Shows the count of other places\",\n                    id: \"otpUi.LocationField.otherCount\"\n                  },\n                  { count: otherFeatures.length }\n                )\n              );\n            }\n            const hasResults = parts.length !== 0;\n            const results = hasResults\n              ? intl.formatList(parts, { type: \"conjunction\" })\n              : intl.formatMessage({\n                  description: \"Indicates no results\",\n                  id: \"otpUi.LocationField.noResults\"\n                });\n            const resultsFoundText = intl.formatMessage(\n              {\n                description: \"Text about geocoder results found\",\n                id: \"otpUi.LocationField.resultsFound\"\n              },\n              {\n                input: text,\n                results\n              }\n            );\n            if (hasResults) {\n              // If there are results, concatenate sentences about results found and\n              // instructions for assistive technology users on how to access results.\n              const instructions = intl.formatMessage({\n                description: \"Instructions on accessing geocoder results\",\n                id: \"otpUi.LocationField.howToAccessResults\"\n              });\n              message = `${resultsFoundText} ${instructions}`;\n            } else {\n              message = resultsFoundText;\n            }\n          }\n          setGeocodedFeatures(geocodedFeatures);\n          setMessage(message);\n          setFetching(false);\n        }\n      )\n      .catch((err: unknown) => {\n        console.error(err);\n        const message = getGeocoderErrorMessage(intl, err.toString());\n        setMessage(message);\n      });\n  });\n\n  /** Clear selection & hide the menu. */\n  const closeMenu = useCallback(() => {\n    setMenuVisible(false);\n    setActiveIndex(null);\n  }, [setMessage, setMenuVisible, setActiveIndex]);\n\n  const setLocation = (newLocation: Location, resultType: ResultType) => {\n    onLocationSelected({\n      location: newLocation,\n      locationType,\n      resultType\n    });\n    closeMenu();\n    setMessage(null);\n  };\n\n  const useCurrentLocation = () => {\n    const newLocation = coreUtils.map.currentPositionToLocation(\n      currentPosition\n    );\n    if (newLocation) {\n      // If geolocation is successful (i.e., user has granted app geolocation\n      // permission and coords exist), set location.\n      onLocationSelected({\n        location: newLocation,\n        locationType,\n        resultType: \"CURRENT_LOCATION\"\n      });\n    } else {\n      // Call geolocation.getCurrentPosition and set as from/to locationType\n      getCurrentPosition(intl, locationType);\n    }\n    setMenuVisible(false);\n  };\n\n  const onClearButtonClick = () => {\n    clearLocation({ locationType });\n    setValue(\"\");\n    setMessage(null);\n    setGeocodedFeatures([]);\n    inputRef.current.focus();\n    handleTextInputClick();\n  };\n\n  const onDropdownToggle = () => {\n    setMenuVisible(!menuVisible);\n  };\n\n  /**\n   * Only hide menu if the target clicked is not a menu item in the dropdown.\n   * Otherwise, the click will not \"finish\" and the menu will hide without the\n   * user having made a selection.\n   */\n  const onBlurFormGroup = e => {\n    // IE does not use relatedTarget, so this check handles cross-browser support.\n    // see https://stackoverflow.com/a/49325196/915811\n    const target =\n      e.relatedTarget !== null ? e.relatedTarget : document.activeElement;\n    if (!target || target.getAttribute(\"role\") !== \"option\") {\n      // Hide the menu and messages, but:\n      // - don't remove features,\n      //   so that when the component gets focus again later, these features are shown\n      //   (unless the location prop changed, in which case the features will be cleared by other code),\n      // - don't revert the input text to previous location, so that users don't have to re-enter their text\n      //   (unless the location prop changed, in which case the text will be updated by other code).\n      closeMenu();\n    }\n  };\n\n  const onTextInputChange = evt => {\n    const { value } = evt.target;\n    setValue(value);\n    setMenuVisible(true);\n\n    // Cancel all pending requests\n    abortControllers.forEach(ac => ac.abort());\n\n    geocodeAutocomplete(value);\n  };\n\n  const handleTextInputClick = () => {\n    if (typeof onTextInputClick === \"function\") onTextInputClick();\n    setMenuVisible(true);\n    if (nearbyStops.length === 0 && currentPosition && currentPosition.coords) {\n      findNearbyStops({\n        lat: currentPosition.coords.latitude,\n        lon: currentPosition.coords.longitude,\n        max: geocoderConfig.maxNearbyStops || 4\n      });\n    }\n  };\n\n  const onKeyDown = evt => {\n    switch (evt.key) {\n      // 'Down' arrow key pressed: move selected menu item down by one position\n      case \"ArrowDown\":\n        // Suppress default 'ArrowDown' behavior which moves cursor to end\n        evt.preventDefault();\n        if (!menuVisible) {\n          // If the menu is not visible, simulate a text input click to show it.\n          handleTextInputClick();\n        } else if (activeIndex === menuItemCount - 1) {\n          setActiveIndex(null);\n        } else {\n          setActiveIndex(activeIndex === null ? 0 : activeIndex + 1);\n        }\n        break;\n      // 'Up' arrow key pressed: move selection up by one position\n      case \"ArrowUp\":\n        // Suppress default 'ArrowUp' behavior which moves cursor to beginning\n        evt.preventDefault();\n        if (activeIndex === 0) {\n          setActiveIndex(null);\n        } else {\n          setActiveIndex(\n            activeIndex === null ? menuItemCount - 1 : activeIndex - 1\n          );\n        }\n        break;\n      // 'Enter' keypress serves two purposes:\n      //  - If pressed when typing in search string, switch from 'autocomplete'\n      //    to 'search' geocoding\n      //  - If pressed when dropdown results menu is active, apply the location\n      //    associated with current selected menu item\n      case \"Enter\":\n        if (typeof activeIndex === \"number\") {\n          // Menu is active\n          // Retrieve location selection handler from lookup object and invoke\n          const locationSelected = locationSelectedLookup[activeIndex];\n          if (locationSelected) locationSelected();\n\n          closeMenu();\n          setMessage(null);\n        } else {\n          // Menu not active; get geocode 'search' results\n          geocodeSearch(evt.target.value);\n          // Ensure menu is visible.\n          setMenuVisible(true);\n        }\n\n        // Suppress default 'Enter' behavior which causes page to reload\n        evt.preventDefault();\n        break;\n      case \"Escape\":\n      case \"Tab\":\n        closeMenu();\n        break;\n      // Any other key pressed: clear active selection\n      default:\n        setActiveIndex(null);\n        break;\n    }\n  };\n\n  const geocodeSearch = text => {\n    if (!text) {\n      console.warn(\"No text entry provided for geocode search.\");\n      return;\n    }\n    getGeocoder(geocoderConfig)\n      .search({ text })\n      .then(result => {\n        if (result?.features?.length > 0) {\n          // Only replace geocode items if results were found\n          setGeocodedFeatures(result.features);\n          setMessage(null);\n        } else {\n          console.warn(\n            \"No results found for geocode search. Not replacing results.\"\n          );\n        }\n      })\n      .catch(err => {\n        console.error(err);\n      });\n  };\n\n  const renderFeature = (itemIndex, feature) => {\n    // generate the friendly labels for this feature\n    const { main, secondary } = generateLabel(feature.properties);\n\n    // Create the selection handler\n    const locationSelected = () => {\n      getGeocoder(geocoderConfig)\n        .getLocationFromGeocodedFeature(feature)\n        .then(geocodedLocation => {\n          // add the friendly location labels for use later on\n          geocodedLocation.main = main;\n          geocodedLocation.secondary = secondary;\n          geocodedLocation.name = getCombinedLabel(feature.properties);\n          // Set the current location\n          setLocation(geocodedLocation, \"GEOCODE\");\n          // Add to the location search history. This is intended to\n          // populate the sessionSearches array.\n          addLocationSearch({ location: geocodedLocation });\n        });\n    };\n\n    // Add to the selection handler lookup (for use in onKeyDown)\n    locationSelectedLookup[itemIndex] = locationSelected;\n\n    // Extract GTFS/POI info and assign to class\n    const { id, source, layer } = feature.properties;\n    const classNames = [];\n    let operatorIcon;\n    // Operator only exists on transit features\n    const featureIdComponents = source === \"transit\" && id.split(\"::\");\n    if (featureIdComponents.length > 1 && featureIdComponents?.[1].length > 0) {\n      const operatorName = featureIdComponents[1]\n        .replace(/ /g, \"-\")\n        .toLowerCase();\n      classNames.push(`operator-${operatorName}`);\n      operatorIcon = operatorIconMap[operatorName];\n    }\n\n    classNames.push(`source-${source}`);\n    classNames.push(`layer-${layer}`);\n\n    // Create and return the option menu item\n    return (\n      <Option\n        classes={classNames.join(\" \")}\n        color={layerColorMap[layer]}\n        icon={operatorIcon || <GeocodedOptionIconComponent feature={feature} />}\n        id={getOptionId(itemIndex)}\n        isActive={itemIndex === activeIndex}\n        key={optionKey++}\n        onClick={locationSelected}\n        title={main}\n        subTitle={secondary}\n      />\n    );\n  };\n\n  const message = stateMessage;\n  const geocodedFeatures = stateGeocodedFeatures;\n\n  if (sessionSearches.length > 5) sessionSearches = sessionSearches.slice(0, 5);\n\n  // Assemble menu contents, to be displayed either as dropdown or static panel.\n  // Menu items are created in four phases: (1) the current location, (2) any\n  // geocoder search results; (3) nearby transit stops; and (4) saved searches\n\n  const statusMessages = [];\n  let menuItems = []; // array of menu items for display (may include non-selectable items e.g. dividers/headings)\n  let itemIndex = 0; // the index of the current location-associated menu item (excluding non-selectable items)\n  const locationSelectedLookup = {}; // maps itemIndex to a location selection handler (for use by the onKeyDown method)\n  const userLocationRenderData = showUserSettings\n    ? userLocationsAndRecentPlaces.map(loc =>\n        getRenderData(loc, setLocation, UserLocationIconComponent, intl)\n      )\n    : [];\n\n  /* 0) Include user saved locations if the typed text contains those locations name. */\n  if (showUserSettings) {\n    const matchingLocations = getMatchingLocations(\n      userLocationRenderData,\n      stateValue\n    );\n    if (matchingLocations.length) {\n      // Iterate through any saved locations\n      menuItems = menuItems.concat(\n        matchingLocations.map(userLocation =>\n          makeUserOption(\n            userLocation,\n            itemIndex++,\n            optionKey++,\n            itemIndex === activeIndex,\n            locationSelectedLookup\n          )\n        )\n      );\n    }\n  }\n\n  /* 1) Process geocode search result option(s) */\n  if (geocodedFeatures.length > 0) {\n    const {\n      otherFeatures,\n      stationFeatures,\n      stopFeatures\n    } = getFeaturesByCategoryWithLimit(\n      geocodedFeatures,\n      suggestionCount,\n      sortByDistance,\n      preferredLayers\n    );\n\n    // If no categories of features are returned, this variable is used to\n    // avoid displaying headers\n    const transitFeaturesPresent =\n      stopFeatures.length > 0 || stationFeatures.length > 0;\n\n    // Iterate through the geocoder results\n    menuItems = menuItems.concat(\n      stationFeatures.length > 0 && (\n        <S.MenuGroupHeader\n          as={headingType}\n          bgColor={layerColorMap.stations}\n          key=\"gtfs-stations-header\"\n        >\n          <FormattedMessage\n            description=\"Text for header above Stations\"\n            id=\"otpUi.LocationField.stations\"\n          />\n        </S.MenuGroupHeader>\n      ),\n      stationFeatures.map(feature => renderFeature(itemIndex++, feature)),\n\n      stopFeatures.length > 0 && (\n        <S.MenuGroupHeader\n          as={headingType}\n          bgColor={layerColorMap.stops}\n          key=\"gtfs-stops-header\"\n        >\n          <FormattedMessage\n            description=\"Text for header above Stops\"\n            id=\"otpUi.LocationField.stops\"\n          />\n        </S.MenuGroupHeader>\n      ),\n      stopFeatures.map(feature => renderFeature(itemIndex++, feature)),\n\n      transitFeaturesPresent && otherFeatures.length > 0 && (\n        <S.MenuGroupHeader as={headingType} bgColor=\"#333\" key=\"other-header\">\n          <FormattedMessage\n            description=\"Text for header above the 'other'\"\n            id=\"otpUi.LocationField.other\"\n          />\n        </S.MenuGroupHeader>\n      ),\n      otherFeatures.map(feature => renderFeature(itemIndex++, feature))\n    );\n  }\n\n  /* 2) Process nearby transit stop options */\n  if (nearbyStops.length > 0 && !suppressNearby) {\n    // Add the menu sub-heading (not a selectable item)\n    menuItems.push(\n      <S.MenuGroupHeader as={headingType} key=\"ns-header\">\n        <FormattedMessage\n          description=\"Text for header above nearby stops\"\n          id=\"otpUi.LocationField.nearby\"\n        />\n      </S.MenuGroupHeader>\n    );\n\n    // Iterate through the found nearby stops\n    menuItems = menuItems.concat(\n      nearbyStops.map(stopId => {\n        // Construct the location\n        const stop = stopsIndex[stopId];\n        const stopLocation = {\n          id: stopId,\n          lat: stop.lat,\n          lon: stop.lon,\n          name: stop.name\n        };\n\n        // Create the location selected handler\n        const locationSelected = () => {\n          setLocation(stopLocation, \"STOP\");\n        };\n\n        // Add to the selection handler lookup (for use in onKeyDown)\n        locationSelectedLookup[itemIndex] = locationSelected;\n\n        // Create and return the option menu item\n        const option = (\n          <TransitStopOption\n            id={getOptionId(itemIndex)}\n            isActive={itemIndex === activeIndex}\n            key={optionKey++}\n            onClick={locationSelected}\n            stop={stop}\n            stopOptionIcon={stopOptionIcon}\n          />\n        );\n        itemIndex++;\n        return option;\n      })\n    );\n  }\n\n  /* 3) Process recent search history options */\n  if (sessionSearches.length > 0) {\n    // Add the menu sub-heading (not a selectable item)\n    menuItems.push(\n      <S.MenuGroupHeader as={headingType} key=\"ss-header\">\n        <FormattedMessage\n          description=\"Text for header above recently searched items\"\n          id=\"otpUi.LocationField.recentlySearched\"\n        />\n      </S.MenuGroupHeader>\n    );\n\n    // Iterate through any saved locations\n    menuItems = menuItems.concat(\n      sessionSearches.map(sessionLocation => {\n        // Create the location-selected handler\n        const locationSelected = () => {\n          setLocation(sessionLocation, \"SESSION\");\n        };\n\n        // Add to the selection handler lookup (for use in onKeyDown)\n        locationSelectedLookup[itemIndex] = locationSelected;\n        // Create and return the option menu item\n        const option = (\n          <Option\n            icon={sessionOptionIcon}\n            id={getOptionId(itemIndex)}\n            isActive={itemIndex === activeIndex}\n            key={optionKey++}\n            onClick={locationSelected}\n            subTitle={sessionLocation.secondary || \"\"}\n            // just use the name if there is no main/secondary field\n            title={sessionLocation.main || sessionLocation.name}\n          />\n        );\n        itemIndex++;\n        return option;\n      })\n    );\n  }\n\n  /* 3b) Process stored user locations */\n  if (userLocationsAndRecentPlaces.length > 0 && showUserSettings) {\n    // Add the menu sub-heading (not a selectable item)\n    menuItems.push(\n      <S.MenuGroupHeader as={headingType} key=\"mp-header\">\n        <FormattedMessage\n          description=\"Text for header above user-saved places\"\n          id=\"otpUi.LocationField.myPlaces\"\n        />\n      </S.MenuGroupHeader>\n    );\n\n    // Iterate through any saved locations\n    menuItems = menuItems.concat(\n      userLocationRenderData.map(userLocation =>\n        makeUserOption(\n          userLocation,\n          itemIndex++,\n          optionKey++,\n          itemIndex === activeIndex,\n          locationSelectedLookup\n        )\n      )\n    );\n  }\n\n  /* 4) Process the current location */\n  let locationSelected;\n  let optionIcon;\n  let optionTitle;\n  let positionUnavailable;\n\n  if (currentPosition && !currentPosition.error) {\n    // current position detected successfully\n    locationSelected = useCurrentLocation;\n    optionIcon = currentPositionIcon;\n    optionTitle = intl.formatMessage({\n      id: \"otpUi.LocationField.useCurrentLocation\"\n    });\n    positionUnavailable = false;\n  } else {\n    // Error detecting current position.\n    // If there is an error, concatenate the error message in parentheses.\n    optionIcon = currentPositionUnavailableIcon;\n    const locationUnavailableText = intl.formatMessage({\n      description: \"Current location unavailable status\",\n      id: \"otpUi.LocationField.currentLocationUnavailable\"\n    });\n    const errorText = !currentPosition\n      ? undefined\n      : typeof currentPosition.error === \"string\"\n      ? currentPosition.error\n      : currentPosition.error.message;\n\n    optionTitle = addInParentheses(intl, locationUnavailableText, errorText);\n    positionUnavailable = true;\n    statusMessages.push(optionTitle);\n  }\n\n  // Add to the selection handler lookup (for use in onKeyDown)\n  locationSelectedLookup[itemIndex] = locationSelected;\n\n  if (!suppressNearby) {\n    // Create and add the option item to the menu items array\n    menuItems.push(\n      <Option\n        disabled={positionUnavailable}\n        icon={optionIcon}\n        id={getOptionId(itemIndex)}\n        isActive={itemIndex === activeIndex}\n        key={optionKey++}\n        onClick={locationSelected}\n        title={optionTitle}\n      />\n    );\n    if (!positionUnavailable) itemIndex++;\n  }\n  if (message) {\n    if (geocodedFeatures.length === 0) {\n      const icon = isFetching ? (\n        <S.Spinner size={ICON_SIZE} />\n      ) : (\n        <ExclamationCircle size={ICON_SIZE} />\n      );\n      menuItems.unshift(\n        <Option disabled icon={icon} key={optionKey++} title={message} />\n      );\n    }\n    statusMessages.push(message);\n  }\n\n  // Store the number of location-associated items for reference in the onKeyDown method\n  let menuItemCount = itemIndex;\n\n  /** the text input element * */\n  // Use this text for aria-label below.\n  const defaultPlaceholder = inputPlaceholder || locationType;\n  const placeholder =\n    currentPosition && currentPosition.fetching\n      ? intl.formatMessage({ id: \"otpUi.LocationField.fetchingLocation\" })\n      : defaultPlaceholder;\n  const hasNoEnabledOptions = menuItemCount === 0;\n  const isExpanded = isStatic || menuVisible;\n\n  const textControl = (\n    <S.Input\n      aria-activedescendant={\n        activeIndex !== null ? getOptionId(activeIndex) : null\n      }\n      aria-autocomplete=\"list\"\n      aria-controls={listBoxId}\n      aria-expanded={isExpanded}\n      aria-haspopup=\"listbox\"\n      aria-invalid={!isValid}\n      aria-label={defaultPlaceholder}\n      aria-required={isRequired}\n      autoFocus={autoFocus}\n      className={formControlClassname}\n      onChange={onTextInputChange}\n      onClick={handleTextInputClick}\n      onKeyDown={onKeyDown}\n      placeholder={placeholder}\n      ref={inputRef}\n      role=\"combobox\"\n      value={stateValue}\n    />\n  );\n\n  // Only include the clear ('X') button add-on if a location is selected\n  // or if the input field has text.\n  const clearButton =\n    showClearButton && location ? (\n      <S.ClearButton\n        aria-label={intl.formatMessage({\n          id: \"otpUi.LocationField.clearLocation\"\n        })}\n        onClick={onClearButtonClick}\n      >\n        {clearButtonIcon}\n      </S.ClearButton>\n    ) : null;\n\n  const ItemList = isStatic ? S.StaticMenuItemList : S.MenuItemList;\n\n  return (\n    <S.InputGroup className={className} onBlur={onBlurFormGroup} role=\"group\">\n      <S.DropdownButton\n        aria-controls={listBoxId}\n        aria-expanded={isExpanded}\n        aria-label={intl.formatMessage({\n          defaultMessage: \"Open the list of location suggestions\",\n          description:\n            \"Text to show as a a11y label for the button that opens the dropdown list of locations\",\n          id: \"otpUi.LocationField.suggestedLocationsLong\"\n        })}\n        onClick={onDropdownToggle}\n        tabIndex={-1}\n      >\n        <LocationIconComponent locationType={locationType} />\n      </S.DropdownButton>\n      {textControl}\n      {clearButton}\n      {/* Note: always render this status tag regardless of the open state,\n          so that assistive technologies correctly set up status monitoring. */}\n      <S.HiddenContent role=\"status\">\n        {/* However, only render the status if the menu is expanded, so that\n            assistive technology reminds user on how to navigate the options. */}\n        {isExpanded && (\n          <FormattedList\n            // eslint-disable-next-line react/style-prop-object\n            style=\"narrow\"\n            type=\"conjunction\"\n            value={statusMessages}\n          />\n        )}\n      </S.HiddenContent>\n      <ItemList\n        // Hide the list from screen readers if no enabled options are shown.\n        aria-hidden={hasNoEnabledOptions}\n        aria-label={intl.formatMessage({\n          defaultMessage: \"Suggested locations\",\n          description:\n            \"Text to show as a label for the dropdown list of locations\",\n          id: \"otpUi.LocationField.suggestedLocations\"\n        })}\n        id={listBoxId}\n      >\n        {isStatic ? (\n          menuItems.length > 0 ? ( // Show typing prompt to avoid empty screen\n            menuItems\n          ) : (\n            <S.MenuGroupHeader as=\"div\">\n              <FormattedMessage\n                defaultMessage=\"Begin typing to search for locations\"\n                description=\"Text to show as initial placeholder in location search field\"\n                id=\"otpUi.LocationField.beginTypingPrompt\"\n              />\n            </S.MenuGroupHeader>\n          )\n        ) : (\n          menuVisible && menuItems\n        )}\n      </ItemList>\n    </S.InputGroup>\n  );\n};\n\nexport default LocationField;\n\n// Rename styled components for export.\nexport { S as Styled };\n"],"file":"index.js"}