{"version":3,"sources":["../src/index.tsx"],"names":["React","useCallback","useEffect","useState","Map","maplibregl","Styled","util","MarkerWithPopup","BaseMap","baseLayer","baseLayerNames","center","children","id","mapLibreProps","maxZoom","onClick","onContextMenu","onViewportChanged","style","zoom","initZoom","latitude","longitude","viewState","setViewState","fakeMobileHover","setFakeHover","longPressTimer","setLongPressTimer","toggleableLayers","Array","isArray","flat","filter","child","props","undefined","alwaysShow","map","layerId","name","visible","layer","hiddenLayers","setHiddenLayers","activeBaseLayer","setActiveBaseLayer","clearLongPressTimer","clearTimeout","evt","e","touchPointCount","points","length","setTimeout","index","includes","updatedLayers","splice","indexOf","push","LayerWrapper","Popup"],"mappings":"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","sourcesContent":["import React, { useCallback, useEffect, useState } from \"react\";\nimport { Map, MapProps } from \"react-map-gl\";\nimport maplibregl, { Event } from \"maplibre-gl\";\n\nimport * as Styled from \"./styled\";\nimport * as util from \"./util\";\nimport MarkerWithPopup from \"./MarkerWithPopup\";\n\n/**\n * The BaseMap component renders a MapLibre map\n * as well as markers that are declared as child elements of the BaseMap element.\n *\n * As BaseMap wraps a react-map-gl Map component, any control which can be added as a child of a react-map-gl map is supported.\n * See https://visgl.github.io/react-map-gl/docs/api-reference/map to see which react-map-gl\n * children are shipped by default. Others are also supported.\n *\n * Overlays are groups of similar MapLibre markers, e.g. vehicle location\n * markers, bus stop markers, etc.\n *\n * Overlays are automatically added to the overlay control displayed by the\n * BaseMap. The user uses that control to turn overlays on or off. Only overlays\n * with an id are added to the control.\n */\ntype Props = React.ComponentPropsWithoutRef<React.ElementType> & {\n  /** A URL, or list of URLs pointing to the vector tile specification which should be used as the main map.  */\n  baseLayer?: string | string[];\n  /** A list of names to match onto the base layers. Used only if there are multiple entries defined for `BaseLayer` */\n  baseLayerNames?: string[];\n  /** A [lat, lon] position to center the map at. */\n  center?: [number, number];\n  /** A unique identifier for the map (useful when using MapProvider) */\n  id?: string;\n  /** An object of props which should be passed down to MapLibre */\n  mapLibreProps?: MapProps;\n  /** The maximum zoom level the map should allow */\n  maxZoom?: number;\n  /** A callback method which is fired when the map is clicked with the left mouse button/tapped */\n  onClick?: (evt: Event) => void;\n  /** A callback method which is fired when the map is clicked with the right mouse button/long tapped */\n  // Unknown is used here because of a maplibre/mapbox issue with the true type, MapLayerMouseEvent\n  onContextMenu?: (e: unknown) => void;\n  /** A callback method which is fired when the map zoom or map bounds change */\n  onViewportChanged?: (e: State) => void;\n  /** An initial zoom value for the map */\n  zoom?: number;\n};\ntype State = {\n  latitude: number;\n  longitude: number;\n  zoom: number;\n};\n\nconst BaseMap = ({\n  // These tiles are free to use, but not in production\n  baseLayer = \"https://basemaps.cartocdn.com/gl/positron-gl-style/style.json\",\n  baseLayerNames,\n  center,\n  children,\n  id,\n  mapLibreProps,\n  maxZoom,\n  onClick,\n  onContextMenu,\n  onViewportChanged,\n  style,\n  zoom: initZoom = 12\n}: Props): JSX.Element => {\n  const [viewState, setViewState] = React.useState<State>({\n    latitude: center?.[0],\n    longitude: center?.[1],\n    zoom: initZoom\n  });\n\n  // Firefox and Safari on iOS: hover is not triggered when the user touches the layer selector\n  // (unlike Firefox or Chromium on Android), so we have to detect touch and trigger hover ourselves.\n  const [fakeMobileHover, setFakeHover] = useState(false);\n  const [longPressTimer, setLongPressTimer] = useState(null);\n\n  useEffect(() => {\n    if (typeof onViewportChanged === \"function\") {\n      onViewportChanged(viewState);\n    }\n  }, [viewState]);\n\n  useEffect(() => {\n    if (center?.[0] === null || center?.[1] === null) return;\n\n    setViewState({\n      ...viewState,\n      latitude: center?.[0],\n      longitude: center?.[1]\n    });\n  }, [center]);\n\n  const toggleableLayers = Array.isArray(children)\n    ? children\n        .flat(10)\n        .filter(\n          child =>\n            child?.props?.id !== undefined &&\n            // Some sources will not have layers as children, and should be ignored\n            // from the list.\n            child?.props?.alwaysShow !== true\n        )\n        .map(child => {\n          const { id: layerId, name, visible } = child.props;\n          return { id: layerId, name, visible };\n        })\n    : [];\n\n  const [hiddenLayers, setHiddenLayers] = useState(\n    toggleableLayers.filter(layer => !layer?.visible).map(layer => layer.id)\n  );\n  const [activeBaseLayer, setActiveBaseLayer] = useState(\n    typeof baseLayer === \"object\" ? baseLayer?.[0] : baseLayer\n  );\n\n  const clearLongPressTimer = useCallback(() => clearTimeout(longPressTimer), [\n    longPressTimer\n  ]);\n\n  return (\n    <Map\n      // eslint-disable-next-line react/jsx-props-no-spreading\n      {...mapLibreProps}\n      id={id}\n      latitude={viewState.latitude}\n      longitude={viewState.longitude}\n      mapLib={maplibregl}\n      mapStyle={activeBaseLayer}\n      maxZoom={maxZoom}\n      onClick={onClick}\n      onContextMenu={onContextMenu}\n      onMove={evt => {\n        setViewState(evt.viewState);\n        clearLongPressTimer();\n      }}\n      onTouchStart={e => {\n        setFakeHover(false);\n        // Start detecting long presses on screens when there is only one touch point.\n        // If the user is pinching the map or does other multi-touch actions, cancel long-press detection.\n        const touchPointCount = e.points.length;\n        if (touchPointCount === 1) {\n          setLongPressTimer(setTimeout(() => onContextMenu(e), 600));\n        } else {\n          clearLongPressTimer();\n        }\n      }}\n      onTouchCancel={clearLongPressTimer}\n      onTouchEnd={clearLongPressTimer}\n      style={style}\n      zoom={viewState.zoom}\n    >\n      {(toggleableLayers.length > 0 ||\n        (!!baseLayer &&\n          typeof baseLayer === \"object\" &&\n          baseLayer.length > 1)) && (\n        <Styled.LayerSelector\n          className=\"filter-group\"\n          id=\"filter-group\"\n          onBlur={() => setFakeHover(false)}\n          onFocus={() => setFakeHover(true)}\n          onTouchEnd={() => setFakeHover(true)}\n        >\n          <ul\n            className={`maplibregl-ctrl-group layers-list ${\n              fakeMobileHover ? \"fake-mobile-hover\" : \"\"\n            }`}\n          >\n            {!!baseLayer &&\n              typeof baseLayer === \"object\" &&\n              baseLayer.map((layer: string, index: number) => {\n                return (\n                  <li key={index}>\n                    {/* eslint-disable-next-line jsx-a11y/label-has-associated-control */}\n                    <label>\n                      <input\n                        checked={activeBaseLayer === layer}\n                        id={layer}\n                        name=\"base-layer\"\n                        onChange={() => setActiveBaseLayer(layer)}\n                        type=\"radio\"\n                      />\n                      {baseLayerNames?.[index] || layer}\n                    </label>\n                  </li>\n                );\n              })}\n\n            {toggleableLayers.map((layer: LayerProps, index: number) => {\n              return (\n                <li key={index}>\n                  {/* eslint-disable-next-line jsx-a11y/label-has-associated-control */}\n                  <label>\n                    <input\n                      checked={!hiddenLayers.includes(layer.id)}\n                      id={layer.id}\n                      onChange={() => {\n                        const updatedLayers = [...hiddenLayers];\n                        // Delete the layer id if present, add it otherwise\n                        updatedLayers.includes(layer.id)\n                          ? updatedLayers.splice(\n                              updatedLayers.indexOf(layer.id),\n                              1\n                            )\n                          : updatedLayers.push(layer.id);\n\n                        setHiddenLayers(updatedLayers);\n                      }}\n                      type=\"checkbox\"\n                    />\n                    {layer.name || layer.id}\n                  </label>\n                </li>\n              );\n            })}\n          </ul>\n        </Styled.LayerSelector>\n      )}\n      {Array.isArray(children)\n        ? children\n            .flat(10)\n            .filter(child => !hiddenLayers.includes(child?.props?.id))\n        : children}\n    </Map>\n  );\n};\n\nexport default BaseMap;\n\ntype LayerProps = React.ComponentPropsWithoutRef<React.ElementType> & {\n  id: string;\n  name?: string;\n  visible?: boolean;\n};\nconst LayerWrapper = (props: LayerProps): JSX.Element => {\n  const { children, visible } = props;\n  return <>{visible && children}</>;\n};\n\nexport const Popup = Styled.Popup;\n\nexport { LayerWrapper, MarkerWithPopup, Styled, util };\n"],"file":"index.js"}