{"version":3,"sources":["../../src/DateTimeSelector/index.tsx"],"names":["format","parse","flatten","coreUtils","React","useCallback","FormattedMessage","useIntl","ModeButton","S","defaultEnglishMessages","defaultMessages","time","getCurrentDate","getCurrentTime","getUserTimezone","OTP_API_DATE_FORMAT","OTP_API_TIME_FORMAT","isInputTypeSupported","type","document","input","createElement","setAttribute","supportsDateTimeInputs","referenceDate","Date","DateTimeSelector","className","date","dateFormatLegacy","departArrive","forceLegacy","onQueryParamChange","style","timeFormatLegacy","timeZone","intl","handleQueryParamChange","queryParam","handleInputChange","key","evt","target","value","handleDateChange","handleTimeChange","handleTimeChangeLegacy","newTime","handleDateChangeLegacy","newDate","setDepartArrive","option","isSelected","departureOptions","text","forEach","opt","isLegacy","formatMessage","id","map"],"mappings":"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","sourcesContent":["import CSS from \"csstype\";\nimport { format, parse } from \"date-fns\";\nimport flatten from \"flat\";\nimport coreUtils from \"@opentripplanner/core-utils\";\nimport React, { ChangeEvent, ReactElement, ReactNode, useCallback } from \"react\";\nimport { FormattedMessage, useIntl } from \"react-intl\";\n\nimport ModeButton from \"../ModeButton\";\nimport * as S from \"../styled\";\n\n// eslint-disable-next-line prettier/prettier\nimport type { QueryParamChangeEvent } from \"../types\";\n\n// Load the default messages.\nimport defaultEnglishMessages from \"../../i18n/en-US.yml\";\n\n// HACK: We should flatten the messages loaded above because\n// the YAML loaders behave differently between webpack and our version of jest:\n// - the yaml loader for webpack returns a nested object,\n// - the yaml loader for jest returns messages with flattened ids.\nconst defaultMessages: Record<string, string> = flatten(defaultEnglishMessages);\n\nconst {\n  getCurrentDate,\n  getCurrentTime,\n  getUserTimezone,\n  OTP_API_DATE_FORMAT,\n  OTP_API_TIME_FORMAT\n} = coreUtils.time;\n\ntype DepartArriveValue = \"NOW\" | \"DEPART\" | \"ARRIVE\";\n\ninterface DateTimeSelectorProps {\n  /**\n   * The CSS class name(s) to apply to this element.\n   */\n  className?: string;\n  /**\n   * The initial departure/arrival date string, in a format that an HTML <input type=\"date\"> control can render.\n   */\n  date?: string;\n  /**\n   * The date format string for legacy mode (on legacy browsers, or if `forceLegacy` is true).\n   */\n  dateFormatLegacy?: string;\n  /**\n   * The initial setting determining whether a trip should start or end at a given time.\n   */\n  departArrive?: DepartArriveValue;\n  /**\n   * If true, forces legacy mode and uses `<input type=\"text\">`\n   * instead of the native date/time pickers found on modern browsers.\n   */\n  forceLegacy?: boolean;\n  /**\n   * Triggered when a query parameter is changed.\n   * @param params A { param1: value1, param2, value2, ... } object that contains the new values for the parameter(s) that has (have) changed.\n   */\n  onQueryParamChange: (e: QueryParamChangeEvent) => void; // FIXME: add types, see interface TransitFareData.\n  /**\n   * Standard React inline style prop.\n   */\n  style?: CSS.Properties;\n  /**\n   * The initial departure/arrival time string, in a format that an HTML <input type=\"time\"> control can render.\n   */\n  time?: string;\n  /**\n   * The time format string for legacy mode (on legacy browsers, or if `forceLegacy` is true).\n   */\n  timeFormatLegacy?: string;\n  /**\n   * An IANA timezone (e.g. \"America/Los_Angeles\") used to convert the \"Leave now\" time\n   * to the transit agency local time.\n   */\n  timeZone?: string;\n}\n\ninterface DepartArriveOption {\n  isSelected?: boolean;\n  text: ReactNode;\n  type: DepartArriveValue;\n}\n\n/**\n * Determines whether the browser supports a particular <input type=<type> /> control,\n * so we can take advantage of native controls\n * (especially date/time selection) on modern (mobile) browsers.\n * @param {*} type One of the HTML5 input types.\n */\nfunction isInputTypeSupported(type: string): boolean {\n  // SSR: use of 'document' variable is only valid in a browser (not server-side)\n  if (typeof document === \"undefined\") return false;\n\n  const input = document.createElement(\"input\");\n  input.setAttribute(\"type\", type);\n  return input.type === type;\n}\n\nconst supportsDateTimeInputs = isInputTypeSupported(\"date\") && isInputTypeSupported(\"time\");\n\n/**\n * Reference date for parsing.\n */\nconst referenceDate = new Date();\n\n/**\n * The `DateTimeSelector` component lets the OTP user chose a departure or arrival date/time.\n * (The departure can be right now.)\n *\n * There are two rendering modes, a \"normal\" mode and a \"legacy\" mode.\n * - \"Normal\" mode: We try to use `<input type=\"time|date\">` for date and time input.\n *   On current HTML5 browsers (desktop or mobile), these controls\n *   render the date/time according to OS settings and natively offer a user interface\n *   for choosing the date/time.\n *   Thus, when `<input type=\"time|date\">` is supported, there is no need to specify a date/time format.\n *   If not, we fall back to \"legacy\" mode.\n * - \"Legacy\" mode: On Safari for MacOS, and on legacy browsers that don't support `<input type=\"time|date\">`,\n *   `<input type=\"time|date\">` renders as the default `<input type=\"text\">`, and in these conditions,\n *   we have to fall back to formatting the date/time ourselves, using `dateFormatLegacy` and `timeFormatLegacy` props.\n * - Implementers don't know in advance whether the browser supports `<input type=\"time|date\">`.\n *   That determination is performed by method `isInputTypeSupported(type)` above when the constructor is executed.\n *   Therefore, they should provide `dateFormatLegacy` and `timeFormatLegacy` props as a backup.\n *   If these props are not provided, the OTP API date format is used.\n * - For testing purposes, implementers can \"force\" the \"legacy\" mode by setting the `forceLegacy` prop to true.\n */\nexport default function DateTimeSelector({\n  className = null,\n  date = null,\n  dateFormatLegacy = OTP_API_DATE_FORMAT,\n  departArrive = \"NOW\",\n  forceLegacy = false,\n  onQueryParamChange = null,\n  style = null,\n  time = null,\n  timeFormatLegacy = OTP_API_TIME_FORMAT,\n  timeZone = getUserTimezone()\n}: DateTimeSelectorProps): ReactElement {\n  const intl = useIntl()\n\n  const handleQueryParamChange = useCallback(\n    (queryParam: QueryParamChangeEvent): void => {\n      if (typeof onQueryParamChange === \"function\") {\n        onQueryParamChange(queryParam);\n      }\n    },\n    [onQueryParamChange]\n  );\n\n  const handleInputChange = (key: string) => useCallback(\n    (evt: ChangeEvent<HTMLInputElement>): void => {\n      handleQueryParamChange({ [key]: evt.target.value });\n    },\n    [onQueryParamChange, key]\n  );\n\n  const handleDateChange = handleInputChange(\"date\");\n\n  const handleTimeChange = handleInputChange(\"time\");\n\n  const handleTimeChangeLegacy = useCallback(\n    (evt: ChangeEvent<HTMLInputElement>): void => {\n      const newTime = format(parse(evt.target.value, timeFormatLegacy, referenceDate), OTP_API_TIME_FORMAT);\n      handleQueryParamChange({ newTime });\n    },\n    [onQueryParamChange]\n  );\n\n  const handleDateChangeLegacy = useCallback(\n    (evt: ChangeEvent<HTMLInputElement>): void => {\n      const newDate = format(parse(evt.target.value, dateFormatLegacy, referenceDate), OTP_API_DATE_FORMAT);\n      handleQueryParamChange({ newDate });\n    },\n    [onQueryParamChange]\n  );\n\n  const setDepartArrive = (option: DepartArriveOption) => useCallback(\n    () => {\n      if (option.type === \"NOW\") {\n        handleQueryParamChange({\n          date: getCurrentDate(timeZone),\n          departArrive: \"NOW\",\n          time: getCurrentTime(timeZone)\n        });\n      } else if (!option.isSelected) {\n        handleQueryParamChange({\n          departArrive: option.type\n        });\n      }\n    },\n    [onQueryParamChange, option.type, option.isSelected, timeZone]\n  );\n\n  const departureOptions: DepartArriveOption[] = [\n    {\n      // Default option.\n      type: \"NOW\",\n      text: (\n        <FormattedMessage\n          defaultMessage={defaultMessages[\"otpUi.DateTimeSelector.now\"]}\n          description=\"Text indicating that the traveler wants to depart as soon as possible (i.e. 'now')\"\n          id=\"otpUi.DateTimeSelector.now\"\n        />\n      )\n    },\n    {\n      type: \"DEPART\",\n      text: (\n        <FormattedMessage\n          defaultMessage={defaultMessages[\"otpUi.DateTimeSelector.depart\"]}\n          description=\"Text indicating that the traveler wants to depart at a given date/time\"\n          id=\"otpUi.DateTimeSelector.depart\"\n        />\n      )\n    },\n    {\n      type: \"ARRIVE\",\n      text: (\n        <FormattedMessage\n          defaultMessage={defaultMessages[\"otpUi.DateTimeSelector.arrive\"]}\n          description=\"Text indicating that the traveler wants to arrive by a certain date/time\"\n          id=\"otpUi.DateTimeSelector.arrive\"\n        />\n      )\n    }\n  ];\n  departureOptions.forEach(opt => {\n    opt.isSelected = departArrive === opt.type;\n  });\n\n  const isLegacy = forceLegacy || !supportsDateTimeInputs;\n\n  return (\n    <S.DateTimeSelector\n      aria-label={intl.formatMessage({ id: \"otpUi.DateTimeSelector.dateTimeSelector\" })}\n      className={className}\n      role=\"group\"\n      style={style}\n    >\n      <S.DateTimeSelector.DepartureRow>\n        {departureOptions.map(opt => (\n          <ModeButton\n            aria-pressed={opt.isSelected}\n            key={opt.type}\n            onClick={setDepartArrive(opt)}\n            selected={opt.isSelected}\n          >\n            {opt.text}\n          </ModeButton>\n        ))}\n      </S.DateTimeSelector.DepartureRow>\n\n      {departArrive !== \"NOW\" && !isLegacy && (\n        <S.DateTimeSelector.DateTimeRow>\n          {/* The <div> elements below are used for layout, see S.DateTimeSelector. */}\n          <div>\n            <input\n              aria-label={intl.formatMessage({ id: \"otpUi.DateTimeSelector.time\" })}\n              onChange={handleTimeChange}\n              required\n              type=\"time\"\n              value={time}\n            />\n          </div>\n          <div>\n            <input\n              aria-label={intl.formatMessage({ id: \"otpUi.DateTimeSelector.date\" })}\n              onChange={handleDateChange}\n              required\n              type=\"date\"\n              value={date}\n            />\n          </div>\n        </S.DateTimeSelector.DateTimeRow>\n      )}\n\n      {/* Backup controls (for older browsers) */}\n      {departArrive !== \"NOW\" && isLegacy && (\n        <S.DateTimeSelector.DateTimeRow>\n          <div>\n            <input\n              defaultValue={format(parse(time, OTP_API_TIME_FORMAT, referenceDate), timeFormatLegacy)}\n              onChange={handleTimeChangeLegacy}\n              required\n              type=\"text\"\n            />\n          </div>\n          <div>\n            <input\n              defaultValue={format(parse(date, OTP_API_DATE_FORMAT, referenceDate), dateFormatLegacy)}\n              onChange={handleDateChangeLegacy}\n              required\n              type=\"text\"\n            />\n          </div>\n        </S.DateTimeSelector.DateTimeRow>\n      )}\n    </S.DateTimeSelector>\n  );\n}\n"],"file":"index.js"}